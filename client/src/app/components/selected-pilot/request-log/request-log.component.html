<div 
    class="step-card"
    [ngClass]="[statusClass, !isRespondable ? 'non-expandable' : '']"
    [class.expanded]="expanded"
    [title]="getStepTooltip(step)"
    (click)="toggleExpand($event)"
    #content
>
    <div class="step-top">
        <span class="step-status" [ngClass]="step.status.toLowerCase()">{{ step.status.toUpperCase() }}</span>
        <span class="step-label">{{ step.label }}</span>
        <span class="step-time">{{ formattedTime }}</span>
    </div>

    <div class="step-message">
        {{ step.message || 'No message provided.' }}
    </div>

    @if (expanded && isRespondable) {
        <div class="step-expanded">
      
          <!-- SMART RESPONSES -->
          <div class="smart-responses">
            @if (smartResponses && smartResponses.length) {
              <div class="section-header">
                Smart responses
              </div>
        
              <div class="chips">
                @for (resp of smartResponses; track resp) {
                  <button type="button" class="chip" (click)="applySmart(resp, $event)">{{ resp }}</button>
                }
              </div>
            }
          </div>
      
          @if (step.step_code === 'DM_131') {
            <div class="direction-buttons">
              <button 
                type="button" 
                class="chip"
                [class.selected]="selectedDirection === 'LEFT'"
                (click)="selectDirection($event, 'LEFT')"
              >
                LEFT
              </button>
              <button 
                type="button" 
                class="chip"
                [class.selected]="selectedDirection === 'RIGHT'"
                (click)="selectDirection($event, 'RIGHT')"
              >
                RIGHT
              </button>
            </div>
          }
          
          @if (isRespondable) {
            <div class="quick-responses">
              <div class="qa-buttons">
                @for (button of quickResponses; track button) {
                  <button 
                    type="button" 
                    class="chip"
                    [class.selected]="selectedAction === button.toLowerCase()"
                    [disabled]="step.step_code === 'DM_131' && !selectedDirection"
                    (click)="setQuickResponse(button, $event)"
                  >
                    {{ button }}
                  </button>
                }
              </div>
            </div>
          }

          <!-- INPUT -->
            <label for="response-input-{{ step.request_id }}"></label>
            <textarea
              id="response-input-{{ step.request_id }}"
              placeholder="Type your response..."
              [(ngModel)]="response"
              (keydown.control.enter)="submitResponse($event)"
              maxlength="500"
              (click)="$event.stopPropagation()"
            ></textarea>
      
          <!-- FOOTER -->
            <div class="response-footer">
              <span class="compose-hint">Ctrl+Enter to send</span>
              
        
              <div class="right-side">
                <span class="char-counter">{{ response.length || 0 }}/500</span>
                <button 
                  [disabled]="!response.length" 
                  type="button" 
                  class="send-btn" 
                  (click)="submitResponse($event)"
                >
                  <span>Send</span>
                  <svg 
                    class="send-icon" 
                    xmlns="http://www.w3.org/2000/svg" 
                    viewBox="0 0 176.368 176.368"
                    width="14" height="14" 
                    aria-hidden="true"
                  >
                    <path 
                      fill-rule="evenodd" 
                      d="M175.865 12.489c2.469-7.408-4.578-14.456-11.986-11.987L6.48 52.969c-8.839 2.946-8.565 15.542.393 18.101l76.552 21.873 21.872 76.552c2.56 8.959 15.155 9.233 18.101.393zm-12.34 7.055-49.116 147.348-21.83-76.403zm-6.701-6.701L85.879 83.788 9.477 61.959z" 
                      clip-rule="evenodd" 
                      fill="#e2e8f0"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
        </div>
      }
      
</div>
